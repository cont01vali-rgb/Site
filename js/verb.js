// Verb data
const verbsData = [
  {"verb":"kommen","traducere":"a veni","exemplu":"Ich komme aus √ñsterreich."},
  {"verb":"wohnen","traducere":"a locui","exemplu":"Ich wohne in Graz."},
  {"verb":"hei√üen","traducere":"a se numi","exemplu":"Ich hei√üe Maria."},
  {"verb":"gehen","traducere":"a merge","exemplu":"Wir gehen ins Kino."},
  {"verb":"lieben","traducere":"a iubi","exemplu":"Er liebt Musik."},
  {"verb":"lernen","traducere":"a √ÆnvƒÉ»õa","exemplu":"Sie lernt Deutsch."},
  {"verb":"sprechen","traducere":"a vorbi","exemplu":"Ich spreche Rum√§nisch und Deutsch."},
  {"verb":"arbeiten","traducere":"a lucra","exemplu":"Er arbeitet im B√ºro."},
  {"verb":"machen","traducere":"a face","exemplu":"Wir machen die Hausaufgaben."},
  {"verb":"spielen","traducere":"a se juca / a juca","exemplu":"Die Kinder spielen im Park."},
  {"verb":"haben","traducere":"a avea","exemplu":"Ich habe Zeit."},
  {"verb":"sein","traducere":"a fi","exemplu":"Das ist richtig."},
  {"verb":"brauchen","traducere":"a avea nevoie","exemplu":"Ich brauche Hilfe."},
  {"verb":"kaufen","traducere":"a cumpƒÉra","exemplu":"Sie kauft ein Brot."},
  {"verb":"trinken","traducere":"a bea","exemplu":"Wir trinken Wasser."},
  {"verb":"essen","traducere":"a m√¢nca","exemplu":"Er isst eine Suppe."},
  {"verb":"fahren","traducere":"a conduce / a cƒÉlƒÉtori","exemplu":"Ich fahre nach Wien."},
  {"verb":"lesen","traducere":"a citi","exemplu":"Sie liest ein Buch."},
  {"verb":"schreiben","traducere":"a scrie","exemplu":"Wir schreiben einen Brief."},
  {"verb":"h√∂ren","traducere":"a auzi / a asculta","exemplu":"Ich h√∂re Musik."},

    // A1 ‚Äì Rutina zilnicƒÉ »ôi ac»õiuni de bazƒÉ
  {"verb":"schlafen","traducere":"a dormi","exemplu":"Ich schlafe acht Stunden.","image":"schlafen.jpeg"},
  {"verb":"kochen","traducere":"a gƒÉti","exemplu":"Ich koche Suppe.","image":"kochen.jpg"},
  {"verb":"waschen","traducere":"a spƒÉla","exemplu":"Ich wasche die H√§nde.","image":"waschen.jpeg"},
  {"verb":"putzen","traducere":"a curƒÉ»õa","exemplu":"Ich putze die Wohnung.","image":"putzen.jpg"},
  {"verb":"einkaufen","traducere":"a face cumpƒÉrƒÉturi","exemplu":"Ich kaufe im Supermarkt ein.","image":"einkaufen.jpg"},
  {"verb":"fr√ºhst√ºcken","traducere":"a lua micul dejun","exemplu":"Ich fr√ºhst√ºcke um acht."},

  // A1 ‚Äì Comunicare
  {"verb":"fragen","traducere":"a √Æntreba","exemplu":"Ich frage den Lehrer."},
  {"verb":"antworten","traducere":"a rƒÉspunde","exemplu":"Ich antworte schnell."},
  {"verb":"sagen","traducere":"a spune","exemplu":"Ich sage die Wahrheit."},
  {"verb":"verstehen","traducere":"a √Æn»õelege","exemplu":"Ich verstehe dich."},

  // A1 ‚Äì Percep»õie »ôi mi»ôcare
  {"verb":"sehen","traducere":"a vedea","exemplu":"Ich sehe den Film."},
  {"verb":"schauen","traducere":"a privi / a se uita","exemplu":"Ich schaue TV."},
  {"verb":"laufen","traducere":"a alerga","exemplu":"Ich laufe im Park.","image":"laufen.jpg"},
  {"verb":"schwimmen","traducere":"a √Ænota","exemplu":"Ich schwimme im Schwimmbad.","image":"schwimmen.jpg"},
  {"verb":"sitzen","traducere":"a sta jos","exemplu":"Ich sitze auf dem Stuhl.","image":"sitzen.jpg"},
  {"verb":"stehen","traducere":"a sta √Æn picioare","exemplu":"Ich stehe im Bus."},

  // A1 ‚Äì Folositoare la cumpƒÉrƒÉturi/ora»ô
  {"verb":"bezahlen","traducere":"a plƒÉti","exemplu":"Ich bezahle die Rechnung."},
  {"verb":"nehmen","traducere":"a lua","exemplu":"Ich nehme den Bus."},
  {"verb":"geben","traducere":"a da","exemplu":"Ich gebe dir das Buch."},
  {"verb":"bringen","traducere":"a aduce","exemplu":"Ich bringe das Wasser."},
  {"verb":"√∂ffnen","traducere":"a deschide","exemplu":"Ich √∂ffne die T√ºr."},
  {"verb":"schlie√üen","traducere":"a √Ænchide","exemplu":"Ich schlie√üe das Fenster."},
  {"verb":"warten","traducere":"a a»ôtepta","exemplu":"Ich warte an der Haltestelle."},
  {"verb":"telefonieren","traducere":"a vorbi la telefon","exemplu":"Ich telefoniere mit Maria."},
  {"verb":"suchen","traducere":"a cƒÉuta","exemplu":"Ich suche meine Brille."},
  {"verb":"finden","traducere":"a gƒÉsi","exemplu":"Ich finde den Schl√ºssel."},
  {"verb":"bleiben","traducere":"a rƒÉm√¢ne","exemplu":"Ich bleibe zu Hause."}
];

window.verbsData = verbsData;

// Load verbs and populate table + nav + TTS
document.addEventListener('DOMContentLoaded', () => {
  const tableBody = document.querySelector('#verbTable tbody');
  const searchInput = document.getElementById('searchInput');
  const paginationEl = document.getElementById('vPagination');
  const paginationInfo = document.getElementById('vPaginationInfo');
  if (!tableBody) return;

  // TTS cu preferin»õƒÉ voce femininƒÉ (DE)
  function speak(text, lang='de-DE') {
    const synth = window.speechSynthesis;
    if (!synth) return;

    function pickDeVoice() {
      const voices = synth.getVoices() || [];
      const de = voices.filter(v => v.lang && /^de(-|_)/i.test(v.lang));

      // Heuristici pentru voce femininƒÉ
      const preferredNames = [
        'Google Deutsch', 'Google Deutsch Female', 'Anna', 'Vicki', 'Petra', 'Marlene', 'Helena', 'Katja', 'Steffi'
      ];

      // 1) Nume preferate
      for (const name of preferredNames) {
        const v = de.find(x => x.name && x.name.toLowerCase().includes(name.toLowerCase()));
        if (v) return v;
      }
      // 2) EuristicƒÉ ‚Äûfemale‚Äù √Æn nume
      const femaleGuess = de.find(v => /fem|frau|female/i.test(v.name || ''));
      if (femaleGuess) return femaleGuess;

      // 3) Prima voce germanƒÉ disponibilƒÉ
      return de[0] || voices.find(v => /german/i.test(v.name || ''));
    }

    const speakNow = () => {
      synth.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = lang;
      const v = pickDeVoice();
      if (v) u.voice = v;
      // op»õional: u.rate = 0.95; u.pitch = 1.05;
      synth.speak(u);
    };

    if (!synth.getVoices().length) {
      const once = () => { synth.onvoiceschanged = null; speakNow(); };
      synth.onvoiceschanged = once;
      setTimeout(speakNow, 200);
    } else {
      speakNow();
    }
  }

  // state
  let filtered = [...verbsData].sort((a,b)=>a.verb.localeCompare(b.verb,'de'));
  let currentPage = 1;
  const pageSize = 25;
  let selectedRowIndex = -1; // index √Æn pagina curentƒÉ

  render();

  // live search
  searchInput?.addEventListener('input', () => {
    const term = normalize(searchInput.value);
    filtered = verbsData.filter(v =>
      normalize(v.verb).includes(term) ||
      normalize(v.traducere || '').includes(term) ||
      normalize(v.exemplu || '').includes(term)
    ).sort((a,b)=>a.verb.localeCompare(b.verb,'de'));
    currentPage = 1;
    selectedRowIndex = -1;
    render();
  });

  // pagination handler
  paginationEl?.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-page]');
    if (!btn) return;
    const p = Number(btn.getAttribute('data-page'));
    if (!Number.isNaN(p)) {
      currentPage = p;
      selectedRowIndex = -1;
      render();
    }
  });

  // keyboard nav + Enter = TTS (ca la Das Nomen)
  document.addEventListener('keydown', (e) => {
    const rows = tableBody.querySelectorAll('tr');
    if (!rows.length) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (selectedRowIndex < rows.length - 1) {
        selectedRowIndex++;
      } else if (selectedRowIndex === -1) {
        selectedRowIndex = 0;
      }
      updateSelection(rows);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (selectedRowIndex > 0) {
        selectedRowIndex--;
        updateSelection(rows);
      }
    } else if (e.key === 'Enter' && selectedRowIndex >= 0) {
      e.preventDefault();
      const globalIndex = (currentPage - 1) * pageSize + selectedRowIndex;
      const item = filtered[globalIndex];
      if (item?.verb) speak(item.verb);
    }
  });

  function updateSelection(rows) {
    rows.forEach((row, i) => {
      if (i === selectedRowIndex) {
        row.classList.add('selected-row');
        row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else {
        row.classList.remove('selected-row');
      }
    });
  }

  function render() {
    tableBody.innerHTML = '';
    if (!filtered.length) {
      tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#666;padding:12px;">Niciun rezultat.</td></tr>`;
      paginationEl && (paginationEl.innerHTML = '');
      paginationInfo && (paginationInfo.textContent = '');
      return;
    }

    const total = filtered.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * pageSize;
    const pageItems = filtered.slice(start, start + pageSize);

    pageItems.forEach((v, i) => {
      const tr = document.createElement('tr');

      // AUDIO BTN (prima coloanƒÉ ca √Æn Das Nomen)
      const audioCell = document.createElement('td');
      const audioBtn = document.createElement('button');
      audioBtn.textContent = 'üîä';
      audioBtn.className = 'audio-btn';
      audioBtn.addEventListener('click', () => speak(v.verb));
      audioCell.appendChild(audioBtn);
      tr.appendChild(audioCell);

      tr.insertAdjacentHTML('beforeend', `
        <td>${escapeHtml(v.verb)}</td>
        <td>${escapeHtml(v.traducere || '')}</td>
        <td>${escapeHtml(v.exemplu || '')}</td>
      `);

      tr.addEventListener('click', () => {
        selectedRowIndex = i;
        updateSelection(tableBody.querySelectorAll('tr'));
      });

      tableBody.appendChild(tr);
    });

    // reset selec»õie la fiecare render
    selectedRowIndex = -1;

    renderPagination(totalPages);
    paginationInfo && (paginationInfo.textContent = `Afi»ôez ${start + 1}‚Äì${start + pageItems.length} din ${total}`);
  }

  function renderPagination(totalPages) {
    if (!paginationEl) return;
    paginationEl.innerHTML = '';
    if (totalPages <= 1) return;

    const mk = (label, page, active=false) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'sub-btn';
      b.setAttribute('data-page', page);
      b.textContent = label;
      if (active) {
        b.style.background = '#2b78c8';
        b.style.color = '#4d0096ff';
      }
      return b;
    };

    paginationEl.appendChild(mk('¬´', Math.max(1, currentPage - 1)));
    const maxButtons = 7;
    let s = Math.max(1, currentPage - Math.floor(maxButtons/2));
    let e = Math.min(totalPages, s + maxButtons - 1);
    if (e - s < maxButtons - 1) s = Math.max(1, e - maxButtons + 1);
    for (let p = s; p <= e; p++) paginationEl.appendChild(mk(String(p), p, p === currentPage));
    paginationEl.appendChild(mk('¬ª', Math.min(totalPages, currentPage + 1)));
  }

  function normalize(str) {
    return String(str || '')
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/ƒÉ|√¢/g,'a').replace(/√Æ/g,'i')
      .replace(/»ô|≈ü/g,'s').replace(/»õ|≈£/g,'t');
  }

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }
});